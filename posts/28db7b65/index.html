<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>koa2初尝试 | Tingtas</title><meta name="description" content="koa2初尝试"><meta name="keywords" content="koa2"><meta name="author" content="Gorkys"><meta name="copyright" content="Gorkys"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/logo/favicon.ico"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="canonical" href="http://tingtas.com/posts/28db7b65/"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="koa2初尝试"><meta name="twitter:description" content="koa2初尝试"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/cover/14.png"><meta property="og:type" content="article"><meta property="og:title" content="koa2初尝试"><meta property="og:url" content="http://tingtas.com/posts/28db7b65/"><meta property="og:site_name" content="Tingtas"><meta property="og:description" content="koa2初尝试"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/cover/14.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="next" title="element-ui之el-image-viewer(图片查看器)" href="http://tingtas.com/posts/8156dfa5/"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9ed4af07fb6daab9ae1845c787dc60fb";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":1,"translateDelay":0,"cookieDomain":"https://tingtas.com/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight_copy: 'true',
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    title: '添加书签',
    message_prev: '按',
    message_next: '键将本页加入书签'
  }
  
}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目结构"><span class="toc-number">2.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目依赖包"><span class="toc-number">3.</span> <span class="toc-text">项目依赖包</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目搭建"><span class="toc-number">4.</span> <span class="toc-text">项目搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#初始化项目"><span class="toc-number">4.1.</span> <span class="toc-text">初始化项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#入口文件"><span class="toc-number">4.2.</span> <span class="toc-text">入口文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Babel引入"><span class="toc-number">4.3.</span> <span class="toc-text">Babel引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热启动"><span class="toc-number">4.4.</span> <span class="toc-text">热启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#断点调试"><span class="toc-number">4.5.</span> <span class="toc-text">断点调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环境搭建"><span class="toc-number">4.6.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#项目流程图"><span class="toc-number">4.6.1.</span> <span class="toc-text">项目流程图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建数据库"><span class="toc-number">4.6.2.</span> <span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成数据结构"><span class="toc-number">4.6.3.</span> <span class="toc-text">生成数据结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#连接数据库"><span class="toc-number">4.6.4.</span> <span class="toc-text">连接数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#数据库操作"><span class="toc-number">4.6.5.</span> <span class="toc-text">数据库操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#业务逻辑操作"><span class="toc-number">4.6.6.</span> <span class="toc-text">业务逻辑操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建路由"><span class="toc-number">4.6.7.</span> <span class="toc-text">创建路由</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#挂载路由"><span class="toc-number">4.6.8.</span> <span class="toc-text">挂载路由</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-测试"><span class="toc-number">4.7.</span> <span class="toc-text">API 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其它接口的完善"><span class="toc-number">4.8.</span> <span class="toc-text">其它接口的完善</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#图片上传"><span class="toc-number">4.8.1.</span> <span class="toc-text">图片上传</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#静态资源"><span class="toc-number">4.8.1.1.</span> <span class="toc-text">静态资源</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#接口编写"><span class="toc-number">4.8.1.2.</span> <span class="toc-text">接口编写</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#获取视频缩略图"><span class="toc-number">4.8.2.</span> <span class="toc-text">获取视频缩略图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#分页查询"><span class="toc-number">4.8.3.</span> <span class="toc-text">分页查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文献"><span class="toc-number">6.</span> <span class="toc-text">参考文献</span></a></li></ol></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/cover/14.png)"><div id="page-header"><span class="pull-left"> <a class="blog_title" id="site-name" href="/">Tingtas</a></span><div class="open toggle-menu pull-right"><div class="menu-icon-first"></div><div class="menu-icon-second"></div><div class="menu-icon-third"></div></div><span class="pull-right menus"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a><script>document.body.addEventListener('touchstart', function(){ });</script></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title"><div class="posttitle">koa2初尝试</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-08-30<span class="post-meta__separator">|</span><i class="fa fa-history" aria-hidden="true"></i> 更新于 2019-08-30</time><span class="post-meta__separator mobile_hidden">|</span><span class="mobile_hidden"><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/node/">node</a></span><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.2k</span><span class="post-meta__separator">|</span><span>阅读时长: 16 分钟</span><span class="post-meta__separator">|</span><span>阅读量: </span><span id="busuanzi_value_page_pv"></span></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>一直都想接触下服务端的内容，以前看过python基础，但是因为在工作中基本上使用不到，所以基础看了几遍没有实际项目操作就忘记了，忘~记~了~</p>
<p>朝三暮四后最终选择了基于Nodejs的中间件Koa2完成了一个简单的RESTful风格的API项目。</p>
<p>项目中主要完成了以下API接口：</p>
<ul>
<li>登录</li>
<li>用户的增删改查</li>
<li>图片上传、视频上传以及获取缩略图</li>
<li>图片、视频列表查询</li>
<li>节目新建(三表关联)</li>
<li>节目查询(三表关联)</li>
</ul>
<blockquote>
<p>项目根据<code>molunerfinn</code>的<a href="https://molunerfinn.com/Vue+Koa/" target="_blank" rel="noopener">全栈开发实战：用Vue2+Koa1开发完整的前后端项目（更新Koa2）</a>教程搭建，在此感谢作者分享。</p>
</blockquote>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── package.json 			// npm的依赖、项目信息文件</span><br><span class="line">├── README.md 				// 说明文件</span><br><span class="line">├── upload  				// 上传文件存储位置</span><br><span class="line">├── index.js  				// Koa入口文件</span><br><span class="line">├── server 					// vue-cli 生成，用于webpack监听、构建</span><br><span class="line">│   ├── config  			// 配置文件夹</span><br><span class="line">│   ├── controllers 		// controller-控制器</span><br><span class="line">│   ├── models 				// model-模型</span><br><span class="line">│   ├── routes 				// route-路由</span><br><span class="line">│   ├── schema 				// schema-数据库表结构</span><br><span class="line">└── └── utils 				// 实用工具</span><br></pre></td></tr></table></figure>
<h2 id="项目依赖包"><a href="#项目依赖包" class="headerlink" title="项目依赖包"></a>项目依赖包</h2><p>以下依赖的版本都是本文所写的时候的版本：</p>
<ul>
<li><p><code>@koa/cors</code>v2.2.3 (跨域)</p>
</li>
<li><p><code>koa</code> v2.7.0</p>
</li>
<li><p><code>koa-body</code> v4.1.0 (解析post以及文件上传)</p>
</li>
<li><p><code>koa-json</code> v2.0.2 (Koa中间件)</p>
</li>
<li><p><code>koa-jwt</code> v3.6.0 (Koa token的中间件)</p>
</li>
<li><p><code>koa-logger</code> v3.2.1 (Koa日志中间件)</p>
</li>
<li><code>koa-router</code> v7.4.0 (Koa路由中间件)</li>
<li><code>mysql2</code> v1.6.5 (nodejs的mysql驱动)</li>
<li><code>sequelize</code> v5.12.1 (操作数据库的ORM)</li>
</ul>
<blockquote>
<p>为什么要使用<code>mysql2</code>呢？因为使用<code>mysql</code>时启动项目<code>sequelize</code>会报<code>Error: Please install mysql2 package manually</code>，提示安装<code>mysql2</code>。</p>
</blockquote>
<h2 id="项目搭建"><a href="#项目搭建" class="headerlink" title="项目搭建"></a>项目搭建</h2><h3 id="初始化项目"><a href="#初始化项目" class="headerlink" title="初始化项目"></a>初始化项目</h3><p>首先我们得新建一个项目文件夹<code>koa-demo</code>，然后用命令行进入该文件夹，执行<code>npm init</code>创建项目描述文件<code>package.json</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">E:\Project\WebStorm\Node\koa-demo&gt; npm init</span><br></pre></td></tr></table></figure>
<p>命令行里会以交互的形式让你填一些项目的介绍信息，依次介绍如下：（不知道怎么填的直接回车、回车…）</p>
<ul>
<li>name 项目名称</li>
<li>version 项目的版本号</li>
<li>description 项目的描述信息</li>
<li>entry point 项目的入口文件</li>
<li>test command 项目启动时脚本命令</li>
<li>git repository 如果你有 Git 地址，可以将这个项目放到你的 Git 仓库里</li>
<li>keywords 关键词</li>
<li>author 作者叫啥</li>
<li>license 项目要发行的时候需要的证书，平时玩玩忽略它</li>
</ul>
<p>然后就可以打开项目文件夹，可以看到自动生成的<code>package.json</code>文件</p>
<h3 id="入口文件"><a href="#入口文件" class="headerlink" title="入口文件"></a>入口文件</h3><p>接下来我们先加入入口文件<code>index.js</code>，写入基本内容：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> Koa <span class="keyword">from</span> <span class="string">'koa'</span></span><br><span class="line"><span class="keyword">import</span> koaRouter <span class="keyword">from</span> <span class="string">'koa-router'</span></span><br><span class="line"><span class="keyword">import</span> json <span class="keyword">from</span> <span class="string">'koa-json'</span></span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'koa-logger'</span></span><br><span class="line"><span class="keyword">import</span> koaBody <span class="keyword">from</span> <span class="string">'koa-body'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa()</span><br><span class="line"><span class="keyword">const</span> router = koaRouter()</span><br><span class="line"></span><br><span class="line">app.use(koaBody())</span><br><span class="line">app.use(json())</span><br><span class="line">app.use(logger())</span><br><span class="line"></span><br><span class="line">app.use(<span class="keyword">async</span> (ctx,next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'error'</span>,(err,ctx) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server error'</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>,()=&gt;&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'服务启动成功,端口：3000,地址：http://localhost:3000'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> app</span><br></pre></td></tr></table></figure>
<p>然后在控制台输入<code>node index.js</code>，发现报错，因为我们使用了es6的<code>import/export</code></p>
<h3 id="Babel引入"><a href="#Babel引入" class="headerlink" title="Babel引入"></a>Babel引入</h3><p>为了支持<code>import/export</code>我们需要引入<code>babel</code>转码器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install @babel/core @babel/node @babel/preset-env @babel/register --save-dev</span><br></pre></td></tr></table></figure>
<p>然后在根目录添加<code>.babelrc</code>文件，写入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    [<span class="string">"@babel/preset-env"</span>, &#123;</span><br><span class="line">      <span class="attr">"targets"</span>: &#123;</span><br><span class="line">        <span class="attr">"node"</span>: <span class="string">"current"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"plugins"</span>: []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在<code>package.json</code>中的<code>scripts</code>写入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "server": "npx babel-node index.js" //使用 npx 省去了输入 babel-node 完整路径的麻烦。</span><br><span class="line">    // or "server": "node_modules/.bin/babel-node index.js"</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>然后运行<code>npm run server</code>就可以了，能看到输出<code>服务启动成功,端口：3000,地址：http://localhost:3000</code>，则说明我们的<code>Koa</code>已经启动成功了，并在3000端口监听。</p>
<h3 id="热启动"><a href="#热启动" class="headerlink" title="热启动"></a>热启动</h3><p>用过vue-cli的都知道前端代码修改过后，会进行热启动，就免去了手动重启项目的麻烦，那么<code>koa2</code>中如何进行热启动呢？<code>nodemon</code>可以帮助我们~</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install nodemon</span><br></pre></td></tr></table></figure>
<p>然后在<code>package.json</code>中的<code>scripts</code>加入</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">    "server": "npx babel-node index.js",</span><br><span class="line">    "start": "nodemon index.js --exec babel-node"</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>最后运行<code>npm run start</code>就可以了</p>
<h3 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h3><p>在IDE中断点调试需要配置一下</p>
<ol>
<li><p>首先在打开菜单栏的<code>Run</code>-&gt;<code>Run Configurations</code></p>
</li>
<li><p>然后点击绿色<code>+</code>号，选择<code>Node.js</code></p>
</li>
<li><p>在右侧的<code>Configuration</code>下面填入对应的参数</p>
<ul>
<li><p><code>Node interpreter</code>：选择node的执行程序</p>
</li>
<li><p><code>Node parameters</code>： 填写参数，参数如下</p>
<blockquote>
<p><code>E:\Project\WebStorm\Node\koa-demo\node_modules\nodemon\bin\nodemon --exec E:\Project\WebStorm\Node\koa-demo\node_modules\.bin\babel-node</code></p>
<p>可以理解为将<code>package.json</code>中的<code>scripts</code>下的<code>start</code>命令加入了完整路径</p>
</blockquote>
</li>
<li><p><code>Working directory</code>：填写项目目录</p>
</li>
<li><p><code>JavaScript file</code>：入口文件</p>
</li>
</ul>
</li>
</ol>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="项目流程图"><a href="#项目流程图" class="headerlink" title="项目流程图"></a>项目流程图</h4><p>为了方便理解项目结构，我做一张图，我们就按照这个顺序进行环境搭建。</p>
<p><img src="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/image/koa2/koa2workflow.png" alt></p>
<h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><p>去<code>MySql</code><a href="https://dev.mysql.com/downloads/" target="_blank" rel="noopener">官网</a>下载一个对应系统的安装程序，安装过程还是比较简单的，这里就不详细描述了</p>
<p>对于初次接触<code>MySql</code>的我，使用命令操作实在有此难为我了，还好之前装了个可视化的工具<code>Navicat</code>(破解版)，当然也有一些免费版的，例如：Windows上<a href="http://www.heidisql.com/" target="_blank" rel="noopener">HediSQL</a>，macOS上<a href="https://www.sequelpro.com/" target="_blank" rel="noopener">Sequel Pro</a>。</p>
<ol>
<li><p>好了，现在我们先创建一个连接<code>koa</code></p>
<ul>
<li>连接名：<code>koa</code></li>
<li>主机名或IP地址：<code>localhost</code></li>
<li>端口：<code>3306</code></li>
<li>用户名： <code>root</code></li>
<li>密码：<code>123456</code></li>
</ul>
</li>
<li><p>然后新建一个数据库<code>demo</code></p>
<ul>
<li>数据库名：<code>demo</code></li>
<li>字符集：<code></code>utf8 – UTF-8 Unicode`</li>
<li>排序规则： <code>utf8_general_ci</code></li>
</ul>
</li>
<li><p>最后我们创建两个表<code>user</code>与<code>resource</code></p>
</li>
</ol>
<p>user表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">字段</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">长度</th>
<th style="text-align:center">主键</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">int(自增)</td>
<td style="text-align:center">255</td>
<td style="text-align:center">1</td>
<td style="text-align:center">用户ID</td>
</tr>
<tr>
<td style="text-align:center">nickname</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">50</td>
<td style="text-align:center"></td>
<td style="text-align:center">昵称</td>
</tr>
<tr>
<td style="text-align:center">username</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">50</td>
<td style="text-align:center"></td>
<td style="text-align:center">用户名</td>
</tr>
<tr>
<td style="text-align:center">password</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">128</td>
<td style="text-align:center"></td>
<td style="text-align:center">密码</td>
</tr>
<tr>
<td style="text-align:center">creationTime</td>
<td style="text-align:center">datetime</td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">创建时间</td>
</tr>
<tr>
<td style="text-align:center">updateTime</td>
<td style="text-align:center">datetime</td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">更新时间</td>
</tr>
</tbody>
</table>
<p>resource表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">字段</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">长度</th>
<th style="text-align:center">主键</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">id</td>
<td style="text-align:center">int(自增)</td>
<td style="text-align:center">125</td>
<td style="text-align:center">1</td>
<td style="text-align:center">资源ID</td>
</tr>
<tr>
<td style="text-align:center">name</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">255</td>
<td style="text-align:center"></td>
<td style="text-align:center">资源名称</td>
</tr>
<tr>
<td style="text-align:center">size</td>
<td style="text-align:center">double</td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">资源大小</td>
</tr>
<tr>
<td style="text-align:center">measure</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">255</td>
<td style="text-align:center"></td>
<td style="text-align:center">分辨率</td>
</tr>
<tr>
<td style="text-align:center">thumbnail</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">255</td>
<td style="text-align:center"></td>
<td style="text-align:center">资源地址</td>
</tr>
<tr>
<td style="text-align:center">operator</td>
<td style="text-align:center">varchar</td>
<td style="text-align:center">255</td>
<td style="text-align:center"></td>
<td style="text-align:center">操作者</td>
</tr>
<tr>
<td style="text-align:center">time</td>
<td style="text-align:center">datetime</td>
<td style="text-align:center">0</td>
<td style="text-align:center"></td>
<td style="text-align:center">创建时间</td>
</tr>
</tbody>
</table>
<h4 id="生成数据结构"><a href="#生成数据结构" class="headerlink" title="生成数据结构"></a>生成数据结构</h4><p>我们需要把数据库的表结构用<code>sequelize-auto</code>导出来。</p>
<blockquote>
<p>更多关于<code>sequelize-auto</code>的使用可以参考<a href="https://github.com/sequelize/sequelize-auto" target="_blank" rel="noopener">官方介绍</a>或者<a href="http://itbilu.com/nodejs/npm/41mRdls_Z.html" target="_blank" rel="noopener">这篇文章</a></p>
</blockquote>
<p>由此，我们首先<strong>全局</strong>安装<code>sequelize-auto</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g sequelize-auto</span><br></pre></td></tr></table></figure>
<p>进入<code>server</code>的目录，执行如下语句</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sequelize-auto -o <span class="string">"./schema"</span> -d demo -h localhost -u root -p 3306 -x 123456 -e mysql</span><br></pre></td></tr></table></figure>
<ul>
<li><code>-o</code> 参数后面的是输出的文件夹目录</li>
<li><code>-d</code> 参数后面的是数据库名</li>
<li><code>-h</code> 参数后面是数据库地址</li>
<li><code>-u</code> 参数后面是数据库用户名</li>
<li><code>-p</code> 参数后面是端口号</li>
<li><code>-x</code> 参数后面是数据库密码，这个要根据自己的数据库密码来！</li>
<li><code>-e</code> 参数后面指定数据库为mysql</li>
</ul>
<p>然后就会在<code>schema</code>文件夹下自动生成两个文件：</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user.js</span></span><br><span class="line"><span class="comment">/* jshint indent: 2 */</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">sequelize, DataTypes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sequelize.define(<span class="string">'user'</span>, &#123;</span><br><span class="line">    id: &#123;</span><br><span class="line">      type: DataTypes.INTEGER(<span class="number">255</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      primaryKey: <span class="literal">true</span>,</span><br><span class="line">      autoIncrement: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    nickname: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">50</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    username: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">50</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    password: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">128</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    creationTime: &#123;</span><br><span class="line">      type: DataTypes.DATE,</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    updateTime: &#123;</span><br><span class="line">      type: DataTypes.DATE,</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    tableName: <span class="string">'user'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// resource.js</span></span><br><span class="line"><span class="comment">/* jshint indent: 2 */</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">sequelize, DataTypes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sequelize.define(<span class="string">'resource'</span>, &#123;</span><br><span class="line">    id: &#123;</span><br><span class="line">      type: DataTypes.INTEGER(<span class="number">125</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      primaryKey: <span class="literal">true</span>,</span><br><span class="line">      autoIncrement: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    name: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">255</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    size: &#123;</span><br><span class="line">      type: <span class="string">"DOUBLE"</span>,</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    measure: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">255</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    thumbnailProxy: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">255</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    operator: &#123;</span><br><span class="line">      type: DataTypes.STRING(<span class="number">255</span>),</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    time: &#123;</span><br><span class="line">      type: DataTypes.DATE,</span><br><span class="line">      allowNull: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    tableName: <span class="string">'resource'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h4><blockquote>
<p>跟数据库打交道的时候我们都需要一个好的操作数据库的工具，能够让我们用比较简单的方法来对数据库进行增删改查。</p>
<p>我选用的是<a href="https://github.com/sequelize/sequelize" target="_blank" rel="noopener"><code>Sequelize</code></a>，它支持多种关系型数据库（<code>Sqlite</code>、<code>MySQL</code>、<code>Postgres</code>等），它的操作基本都能返回一个<code>Promise</code>对象，这样在Koa里面我们能够很方便地进行”同步”操作。</p>
<p>更多关于<code>Sequelize</code>的用法，可以参考<a href="http://docs.sequelizejs.com/en/latest/" target="_blank" rel="noopener">官方文档</a>，以及这几篇文章——<a href="https://github.com/demopark/sequelize-docs-Zh-CN" target="_blank" rel="noopener">Sequelize中文API文档</a>、<a href="https://kohpoll.github.io/blog/2015/11/12/sequelize-to-mysql/" target="_blank" rel="noopener">Sequelize和MySQL对照</a>、<a href="http://semlinker.com/node-sequelize-quickstart/" target="_blank" rel="noopener">Sequelize快速入门</a></p>
</blockquote>
<p>安装<code>Sequelize</code>依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save sequelize</span><br></pre></td></tr></table></figure>
<p>然后在<code>server</code>目录下的<code>config</code>目录下我们新建一个<code>db.js</code>，用于初始化<code>Sequelize</code>和数据库的连接。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/db.js</span></span><br><span class="line"><span class="keyword">import</span> Sequelize <span class="keyword">from</span> <span class="string">'sequelize'</span> <span class="comment">// 引入sequelize</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用url连接的形式进行连接，注意将root: 后面的XXXX改成自己数据库的密码</span></span><br><span class="line"><span class="keyword">const</span> demo = <span class="keyword">new</span> Sequelize(<span class="string">'mysql://root:123456@127.0.0.1/demo'</span>,&#123;</span><br><span class="line">    define:&#123;</span><br><span class="line">        <span class="comment">// 取消Sequelzie自动给数据表加入时间戳（createdAt以及updatedAt）</span></span><br><span class="line">        timestamps: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    timezone: <span class="string">'+08:00'</span> <span class="comment">// 时差区，国内需要加入不然存储的时间会有时差</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> demo <span class="comment">// 将demo暴露出接口方便Model调用</span></span><br></pre></td></tr></table></figure>
<h4 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h4><p>接着我们去<code>models</code>文件夹里将数据库和表结构文件连接起来。在这个文件夹下新建一个<code>user.js</code>的文件。</p>
<p>所谓增、删、改、查，那么我们就先来写一个新增用户的操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/user.js</span></span><br><span class="line"><span class="keyword">import</span> demoDB <span class="keyword">from</span> <span class="string">'../config/db'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入user的表结构</span></span><br><span class="line"><span class="keyword">const</span> userModel = <span class="string">'../schema/user.js'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用sequelize的import方法引入表结构，实例化了User。</span></span><br><span class="line"><span class="keyword">const</span> User = demoDB.import(userModel)</span><br><span class="line"></span><br><span class="line"><span class="comment">// async 异步操作</span></span><br><span class="line"><span class="keyword">const</span> addUser = <span class="keyword">async</span> (userInfo) =&gt; &#123;</span><br><span class="line"> <span class="keyword">await</span> User.create(userInfo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  addUser</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="业务逻辑操作"><a href="#业务逻辑操作" class="headerlink" title="业务逻辑操作"></a>业务逻辑操作</h4><p>现在我们就需要写一写接收参数后的一些操作以及返回信息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/user.js</span></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">'../models/login'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postUserInfo = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = ctx.request.body</span><br><span class="line">  <span class="keyword">const</span> userAuth = <span class="keyword">await</span> login.getUserByName(data.username)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(userAuth === <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> userInfo = &#123;</span><br><span class="line">      username: data.username,</span><br><span class="line">      password: data.password,</span><br><span class="line">      nickname: data.nickname,</span><br><span class="line">      creationTime: dataTime(),</span><br><span class="line">      updateTime: dataTime()</span><br><span class="line">    &#125;</span><br><span class="line">    user.addUser(userInfo)</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      code: <span class="string">'0000'</span>,</span><br><span class="line">      info: <span class="string">'新建成功!'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      code: <span class="string">'9999'</span>,</span><br><span class="line">      info: <span class="string">'用户已存在!'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  postUserInfo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写完这个还不能直接请求，因为我们还没有定义路由，请求经过<code>Koa</code>找不到这个路径是没有反应的。</p>
<h4 id="创建路由"><a href="#创建路由" class="headerlink" title="创建路由"></a>创建路由</h4><p>在<code>routes</code>文件夹下写一个<code>api.js</code>的文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/api.js</span></span><br><span class="line"><span class="keyword">import</span> user <span class="keyword">from</span> <span class="string">'../controllers/user'</span></span><br><span class="line"><span class="keyword">import</span> koaRouter <span class="keyword">from</span> <span class="string">'koa-router'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = koaRouter()</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/user'</span>,user.postUserInfo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>
<p>至此我们已经接近完成我们的第一个API了，还缺最后一步，将这个路由规则“挂载”到Koa上去。</p>
<h4 id="挂载路由"><a href="#挂载路由" class="headerlink" title="挂载路由"></a>挂载路由</h4><p>为了节约篇幅，下面省略了一些代码，只写了上下文作为位置标记</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">import</span> logger <span class="keyword">from</span> <span class="string">'koa-logger'</span></span><br><span class="line"><span class="keyword">import</span> koaRouter <span class="keyword">from</span> <span class="string">'koa-router'</span></span><br><span class="line"><span class="keyword">const</span> router = koaRouter()</span><br><span class="line"><span class="keyword">import</span> api <span class="keyword">from</span> <span class="string">'./server/routes/api.js'</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">app.on(<span class="string">'error'</span>,(err,ctx) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'server error'</span>, err)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂载到koa-router上，同时会让所有的auth的请求路径前面加上'/auth'的请求路径</span></span><br><span class="line">router.use(<span class="string">'/api'</span>, api.routes()) </span><br><span class="line"><span class="comment">// 将路由规则挂载到Koa上。</span></span><br><span class="line">app.use(router.routes())</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>,()=&gt;&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'服务启动成功,端口：3000,地址：http://localhost:3000'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>打开你的控制台，输入<code>node app.js</code>，一切运行正常没有报错的话，大功告成，我们的第一个API已经构建完成！</p>
<h3 id="API-测试"><a href="#API-测试" class="headerlink" title="API 测试"></a>API 测试</h3><p>接口在跟前端对接之前，我们应该先进行一遍测试，防止出现问题。</p>
<p>在测试接口的工具上我想<code>postman</code>的大名应该众所周知了，<a href="https://www.getpostman.com/" target="_blank" rel="noopener">官网</a>下载安装好后便可使用。</p>
<h3 id="其它接口的完善"><a href="#其它接口的完善" class="headerlink" title="其它接口的完善"></a>其它接口的完善</h3><p>刚才实现的不过是一个简单的用户新增接口，但是我们要实现一个完整的系统demo，还需要做一些工作。</p>
<p>剩下的API添加，基本上只需要在<code>model</code>和<code>controllers</code>写好方法，定好接口即可~</p>
<p>下面主要列举一下<code>上传接口</code>以及<code>分页查询接口</code>的一些知识点。</p>
<h4 id="图片上传"><a href="#图片上传" class="headerlink" title="图片上传"></a>图片上传</h4><p>在项目根目录下我们创建的有一个<code>upload</code>文件夹，上传成功后的图片就存储到这里，那么这里的图片怎么通过链接访问呢？这就需要我们搭建一个简易的静态资源服务器了。</p>
<h5 id="静态资源"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源</h5><p>这里提供两种方法：</p>
<ol>
<li><p>koa-static中间件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install koa-static</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="keyword">import</span> statics <span class="keyword">from</span> <span class="string">'koa-static'</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span></span><br><span class="line"></span><br><span class="line">app.use(logger())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态服务</span></span><br><span class="line">app.use(statics(path.join(__dirname, <span class="string">'./upload/'</span>)))</span><br></pre></td></tr></table></figure>
<p>我们在upload目录下新建一个<code>image</code>文件夹，用来放图片文件，然后挂载好后启动服务就可以使用<code>http://localhost:3000/image/test.jpg</code>查看图片了。</p>
<blockquote>
<p><strong>注意：</strong>将<code>upload</code>目录配置为静态资源，那么访问的时候不需要输入<code>upload</code>，而是直接访问下级目录</p>
</blockquote>
</li>
</ol>
<ol start="2">
<li><p>Nginx搭建静态资源</p>
<p>这里使用<code>Nginx</code>进行搭建，在<a href="https://nginx.org/en/download.html" target="_blank" rel="noopener">官网</a>下载稳定版本，解压后打开<code>conf</code>文件夹下的<code>nginx.conf</code>进行修改配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen       3001;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        location /upload/ &#123;</span><br><span class="line">            root E:/Project/WebStorm/Node/koa-demo/;</span><br><span class="line">            autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后运行<code>nginx.exe</code>即可，然后我们在<code>upload</code>中添加一张图片，打开浏览器输入<code>http://localhost:3001/upload/test.jpg</code>便可看见图片</p>
</li>
</ol>
<h5 id="接口编写"><a href="#接口编写" class="headerlink" title="接口编写"></a>接口编写</h5><p>在<code>models</code>下创建一个<code>resource.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/resource.js</span></span><br><span class="line"><span class="keyword">import</span> demoDB <span class="keyword">from</span> <span class="string">'../config/db'</span></span><br><span class="line"><span class="keyword">const</span> resModel = <span class="string">'../schema/resource'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Res = demoDB.import(resModel)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postResImage = <span class="keyword">async</span> data =&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> Res.create(data)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  postResImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要是用来存储图片的一些数据到数据库</p>
<p>下面我们在<code>controllers</code>下创建一个<code>resource.js</code></p>
<blockquote>
<p>多文件需要遍历<code>ctx.request.files</code>，与文件一起传过来的参数在<code>ctx.request.body</code>中获取</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/resource.js</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">'fs'</span></span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">'path'</span></span><br><span class="line"><span class="keyword">import</span> res <span class="keyword">from</span> <span class="string">'../models/resource'</span></span><br><span class="line"><span class="keyword">import</span> formatTime <span class="keyword">from</span> <span class="string">'../utils/formatTime'</span></span><br><span class="line"><span class="keyword">import</span> _res <span class="keyword">from</span> <span class="string">'../utils/response'</span></span><br><span class="line"><span class="keyword">import</span> probe <span class="keyword">from</span> <span class="string">'probe-image-size'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> imageUrl = <span class="string">'http://localhost:3000/image/'</span></span><br><span class="line"><span class="keyword">const</span> imagePath = path.join(__dirname,<span class="string">'../../upload/image'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> videoUrl = <span class="string">'http://localhost:3000/video/'</span></span><br><span class="line"><span class="keyword">const</span> videoPath = path.join(__dirname,<span class="string">'../../upload/video'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uploadImage = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> file = ctx.request.files.file;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> reader = fs.createReadStream(file.path);	<span class="comment">// 创建可读流</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取图片流的尺寸,注意，这里不能直接使用reader,不然会导致图片损坏。</span></span><br><span class="line">    <span class="keyword">let</span> measure = <span class="keyword">await</span> probe(fs.createReadStream(file.path))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> upStream = fs.createWriteStream(<span class="string">`<span class="subst">$&#123;imagePath&#125;</span>\\<span class="subst">$&#123;file.name&#125;</span>`</span>);		<span class="comment">// 创建可写流</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> data = &#123;</span><br><span class="line">      name : file.name,</span><br><span class="line">      size : (file.size / <span class="number">1024</span> / <span class="number">1024</span>).toFixed(<span class="number">2</span>),</span><br><span class="line">      measure : <span class="string">`<span class="subst">$&#123;measure.width&#125;</span>*<span class="subst">$&#123;measure.height&#125;</span>`</span>,</span><br><span class="line">      thumbnailProxy : <span class="string">`<span class="subst">$&#123;imageUrl&#125;</span><span class="subst">$&#123;file.name&#125;</span>`</span>,</span><br><span class="line">      operator : <span class="string">'admin'</span>,</span><br><span class="line">      time : formatTime()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> res.postRes(data)</span><br><span class="line">    <span class="keyword">if</span>(!fs.existsSync(imagePath))&#123;</span><br><span class="line">      fs.mkdir(imagePath,err =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span>(err) <span class="keyword">throw</span> err</span><br><span class="line">        reader.pipe(upStream)	<span class="comment">// 可读流通过管道写入可写流</span></span><br><span class="line">        <span class="keyword">return</span> ctx.body = _res.success(<span class="string">'上传成功'</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">      reader.pipe(upStream)	<span class="comment">// 可读流通过管道写入可写流</span></span><br><span class="line">      <span class="keyword">return</span> ctx.body = _res.success(<span class="string">'上传成功'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  uploadImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>接收到图片后，再想获取图片的尺寸需要<code>npm install probe-image-size</code>，刚开始的时候一直在<code>image-size</code>上折腾，真是搞了好久，一直以为是自己哪里用法不对。后来才发现是对流形式的不支持，就换到了<code>probe-image-size</code>.</p>
</blockquote>
<p>最后在<code>routes</code>添加接口</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/api.js</span></span><br><span class="line"><span class="keyword">import</span> koaRouter <span class="keyword">from</span> <span class="string">'koa-router'</span></span><br><span class="line"><span class="keyword">const</span> router = koaRouter()</span><br><span class="line"><span class="keyword">import</span> resource <span class="keyword">from</span> <span class="string">'../controllers/resource'</span></span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/upload/image'</span>,resource.uploadImage)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>
<h4 id="获取视频缩略图"><a href="#获取视频缩略图" class="headerlink" title="获取视频缩略图"></a>获取视频缩略图</h4><p>上传视频后在我们一般都需要获取视频的缩略图，用来在前端列表中展示。</p>
<p>我们使用<code>FFmpeg</code>，一个领先的多媒体框架。</p>
<p>首先在<a href="http://ffmpeg.org/download.html" target="_blank" rel="noopener">官网下载</a>对应平台的包。我这里使用的是windows，下载完成后将<code>FFmpeg</code>解压到<code>D:\ffmpeg</code>下。</p>
<p>并配置好系统的环境变量，添加<code>D:\ffmpeg\bin</code>到系统变量。详细<a href="https://blog.csdn.net/qq_19788257/article/details/83011732" target="_blank" rel="noopener">点击查看</a></p>
<blockquote>
<p>如果设置环境变量无效的话，还可以手动设置ffpemg的位置。</p>
<p><code>FFMpeg.setFfmpegPath(&#39;D:/ffmpeg/bin/ffmpeg.exe&#39;)</code></p>
</blockquote>
<p>然后在项目目录安装node的中间件<code>fluent-ffmpeg</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install fluent-ffmpeg</span><br></pre></td></tr></table></figure>
<p>然后就可以使用了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> FFMpeg <span class="keyword">from</span> <span class="string">'fluent-ffmpeg'</span></span><br><span class="line">FFMpeg.setFfmpegPath(<span class="string">'D:/ffmpeg/bin/ffmpeg.exe'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> screenshots = <span class="function"><span class="keyword">function</span>(<span class="params">fileName</span>)</span>&#123;</span><br><span class="line">  FFMpeg(<span class="string">'upload/video/'</span>+ fileName)</span><br><span class="line">    .screenshots(&#123;</span><br><span class="line">      timemarks: [<span class="string">'0.5'</span>],</span><br><span class="line">      filename: <span class="string">'thumbnail-%b.png'</span>,</span><br><span class="line">      count: <span class="number">1</span>,</span><br><span class="line">      folder: <span class="string">'upload/video'</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  screenshots</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其它操作请参考<a href="https://github.com/fluent-ffmpeg/node-fluent-ffmpeg" target="_blank" rel="noopener">官方文档</a></p>
<h4 id="分页查询"><a href="#分页查询" class="headerlink" title="分页查询"></a>分页查询</h4><p>这里的查询主要是查询上传的图片的信息，返回给前端进行列表展示。</p>
<p>所以接口与上传接口同在<code>resource.js</code>文件中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/resource.js</span></span><br><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">const</span> getResImage = <span class="keyword">async</span> (data) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; pageNo, pageSize &#125; = data</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">await</span> Res.findAndCountAll(&#123;</span><br><span class="line">      limit: <span class="built_in">parseInt</span>(pageSize),</span><br><span class="line">      offset: (<span class="built_in">parseInt</span>(pageNo)<span class="number">-1</span>) * <span class="built_in">parseInt</span>(pageSize),</span><br><span class="line">    &#125;).then(<span class="function"><span class="params">result</span>=&gt;</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  getResImage,</span><br><span class="line">  postResImage</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/resource.js</span></span><br><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"><span class="keyword">const</span> getResImageList = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> data = ctx.query</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> list = <span class="keyword">await</span> res.getResImage(data)</span><br><span class="line">  <span class="keyword">const</span> _resData = &#123;</span><br><span class="line">    pages:&#123;</span><br><span class="line">      total: list.count</span><br><span class="line">    &#125;,</span><br><span class="line">    sources: list.rows</span><br><span class="line">  &#125;</span><br><span class="line">  ctx.body = _res.success(<span class="string">'成功'</span>,_resData)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  uploadFile,</span><br><span class="line">  getResImageList</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// router/api.js</span></span><br><span class="line">router.get(<span class="string">'/resource/image'</span>,resource.getResImageList)</span><br></pre></td></tr></table></figure>
<p>至此，KOA2中实现RESTFul 风格的API就算完成了。</p>
<blockquote>
<p>一对多的多表分页查询时会在子查询里中分页，可使用<code>subQuery:true</code>。详见项目中节目查询的代码。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>最后将本文的项目代码放至了<a href="https://www.github.com/gorkys/koa-demo" target="_blank" rel="noopener">Github</a>，如果这个项目对你有帮助，希望大家可以fork，给我提建议，如果再有时间，可以点个Star那就更好啦~</p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://molunerfinn.com/Vue+Koa/" target="_blank" rel="noopener">全栈开发实战：用Vue2+Koa1开发完整的前后端项目（更新Koa2）</a></li>
<li><a href="http://www.ptbird.cn/koa-body.html" target="_blank" rel="noopener">koa2 使用 koa-body 代替 koa-bodyparser 和 koa-multer</a></li>
<li><a href="https://juejin.im/post/5abc451ff265da23a2292dd4" target="_blank" rel="noopener">Koa2 之文件上传下载</a></li>
<li><a href="https://www.cnblogs.com/tugenhua0707/p/10828869.html" target="_blank" rel="noopener">koa2基于stream(流)进行文件上传和下载</a></li>
<li><a href="http://blog.lanvige.com/2018/12/06/babel-v7/" target="_blank" rel="noopener">Babel v7 指南</a></li>
<li><a href="[https://medium.com/10coding/node-js-%E4%BD%BF%E7%94%A8-babel-%E5%81%9A-es6-%E9%96%8B%E7%99%BC-44b5b9e5f508](https://medium.com/10coding/node-js-使用-babel-做-es6-開發-44b5b9e5f508">[Node.js] 使用 Babel 做 ES6 開發</a>)</li>
<li><a href="https://blog.csdn.net/super_wangl/article/details/78239189" target="_blank" rel="noopener">nodemon webstorm 配置应用</a></li>
<li><a href="https://blog.csdn.net/qq_30101131/article/details/79474905" target="_blank" rel="noopener">sequelize联表查询</a></li>
<li><a href="https://segmentfault.com/a/1190000017320533" target="_blank" rel="noopener"> Sequelize 多对多的创建、查询、更新</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gorkys</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://tingtas.com/posts/28db7b65/">http://tingtas.com/posts/28db7b65/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://tingtas.com">Tingtas</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/koa2/">koa2    </a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/cover/14.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-buttom"><i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lozad post-qr-code__img" data-src="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/sponsor/wechat.jpg"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lozad post-qr-code__img" data-src="https://cdn.jsdelivr.net/gh/gorkys/CDN-Blog@master/blog/sponsor/alipay.png"><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/posts/8156dfa5/"><img class="next_cover lozad" data-src="https://i.loli.net/2019/06/12/5d006dff2f06625968.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="label">下一篇</div><div class="next_info"><span>element-ui之el-image-viewer(图片查看器)</span></div></a></div></nav><div class="relatedPosts"></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '657d283dd929cdf5f9b2',
  clientSecret: 'd53236c0a501a10cafd334ecce05aecde7472306',
  repo: 'gorkys.github.io',
  owner: 'gorkys',
  admin: 'gorkys',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Gorkys</div><div class="framework-info"><span>驱动 </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly"><span>Butterfly</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><section class="rightside" id="rightside"><i class="fa fa-book" id="readmode" title="阅读模式"> </i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换">繁</a><i class="fa fa-moon-o nightshift" id="nightshift" title="夜间模式"></i></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/baidupush.js"></script><script async src="/js/search/local-search.js"></script><script src="/js/nightshift.js"></script><script id="ribbon" src="https://cdn.jsdelivr.net/gh/jerryc127/CDN@latest/js/piao.js"></script><script src="/js/activate-power-mode.js"></script><script>POWERMODE.colorful = true; // make power mode colorful
POWERMODE.shake = true; // turn off shake
document.body.addEventListener('input', POWERMODE);
</script><script src="/js/tw_cn.js"></script><script>translateInitilization()

</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@1.2.2/instantpage.min.js" type="module"></script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>